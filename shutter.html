<script>
  const lb = document.getElementById('lightbox');
  const lbImg = document.getElementById('lb-img');
  const lbCaption = document.getElementById('lb-caption');
  const btnClose = document.querySelector('.lb-close');
  const btnPrev = document.querySelector('.lb-prev');
  const btnNext = document.querySelector('.lb-next');

  let images = [];
  let index = 0;
  let title = '';
  let caption = '';

  // mobile-only lock
  let isSwitching = false;
  let unlockTimer = null;

  function isMobileNow(){
    return window.matchMedia("(max-width:700px)").matches;
  }

  function preload(src){
    if(!src) return;
    const im = new Image();
    im.decoding = "async";
    im.src = src;
  }

  function safeIndex(i){
    if(!images.length) return 0;
    return (i + images.length) % images.length;
  }

  function setNavDisabled(disabled){
    btnPrev.disabled = disabled;
    btnNext.disabled = disabled;
  }

  // ✅ show/hide arrows depending on count
  function updateArrows(){
    const multi = images.length > 1;
    btnPrev.style.display = multi ? "" : "none";
    btnNext.style.display = multi ? "" : "none";
    btnPrev.disabled = !multi;
    btnNext.disabled = !multi;
  }

  function lockIfMobile(){
    if(!isMobileNow()) return;

    isSwitching = true;
    setNavDisabled(true);

    if(unlockTimer) clearTimeout(unlockTimer);
    unlockTimer = setTimeout(() => {
      isSwitching = false;
      setNavDisabled(false);
      unlockTimer = null;
    }, 500);
  }

  function unlock(){
    if(unlockTimer){
      clearTimeout(unlockTimer);
      unlockTimer = null;
    }
    isSwitching = false;
    setNavDisabled(false);
  }

  function render(){
    if(!images.length) return;

    updateArrows();

    const src = images[index];
    const counter = `${index + 1}/${images.length}`;
    lbImg.alt = title ? `${title} (${counter})` : `Photo ${counter}`;

    lbImg.style.opacity = 0;

    preload(images[safeIndex(index)]);
    preload(images[safeIndex(index + 1)]);
    preload(images[safeIndex(index - 1)]);

    lockIfMobile();

    const tmp = new Image();
    tmp.decoding = "async";

    tmp.onload = () => {
      lbImg.src = src;
      requestAnimationFrame(() => { lbImg.style.opacity = 1; });
      unlock();
    };

    tmp.onerror = () => {
      lbImg.src = src;
      requestAnimationFrame(() => { lbImg.style.opacity = 1; });
      unlock();
    };

    tmp.src = src;

    lbCaption.textContent = title
      ? `${title} — ${counter}${caption ? " · " + caption : ""}`
      : counter;

    lb.scrollTop = 0;
  }

  function openLightbox(list, t, c){
    images = list;
    index = 0;
    title = t || '';
    caption = c || '';

    lb.classList.add('open');
    lb.setAttribute('aria-hidden','false');
    document.body.style.overflow = 'hidden';
    document.body.classList.add('lb-open');

    lb.scrollTop = 0;
    render();
  }

  function closeLightbox(){
    lb.classList.remove('open');
    lb.setAttribute('aria-hidden','true');
    document.body.style.overflow = '';
    document.body.classList.remove('lb-open');
    unlock();
  }

  function prev(){
    if(images.length <= 1) return;
    if(isMobileNow() && isSwitching) return;
    index = safeIndex(index - 1);
    render();
  }

  function next(){
    if(images.length <= 1) return;
    if(isMobileNow() && isSwitching) return;
    index = safeIndex(index + 1);
    render();
  }

  document.querySelectorAll('.album').forEach(card => {
    card.addEventListener('click', () => {
      const list = (card.dataset.images || '')
        .split(',')
        .map(s => s.trim())
        .filter(Boolean);

      if(!list.length) return;
      openLightbox(list, card.dataset.title, card.dataset.caption);
    });
  });

  btnClose.addEventListener('click', closeLightbox);
  btnPrev.addEventListener('click', prev);
  btnNext.addEventListener('click', next);

  lb.addEventListener('click', (e) => {
    if(e.target === lb) closeLightbox();
  });

  window.addEventListener('keydown', (e) => {
    if(!lb.classList.contains('open')) return;
    if(e.key === 'Escape') closeLightbox();
    if(e.key === 'ArrowLeft') prev();
    if(e.key === 'ArrowRight') next();
  });

  /* Swipe support (mobile) */
  let startX = 0, startY = 0;
  let tracking = false;
  let lockedDirection = null;
  const SWIPE_MIN = 45;
  const LOCK_THRESHOLD = 10;

  function onTouchStart(e){
    if(!lb.classList.contains('open')) return;
    if(!e.touches || e.touches.length !== 1) return;
    const t = e.touches[0];
    startX = t.clientX;
    startY = t.clientY;
    tracking = true;
    lockedDirection = null;
  }

  function onTouchMove(e){
    if(!tracking) return;
    if(!lb.classList.contains('open')) return;
    if(!e.touches || e.touches.length !== 1) return;

    const t = e.touches[0];
    const dx = t.clientX - startX;
    const dy = t.clientY - startY;

    if(!lockedDirection){
      if(Math.abs(dx) > LOCK_THRESHOLD || Math.abs(dy) > LOCK_THRESHOLD){
        lockedDirection = Math.abs(dx) > Math.abs(dy) ? "x" : "y";
      } else {
        return;
      }
    }

    if(lockedDirection === "x"){
      e.preventDefault();
    }
  }

  function onTouchEnd(e){
    if(!tracking) return;
    tracking = false;

    if(!lb.classList.contains('open')) return;
    if(lockedDirection !== "x") return;
    if(images.length <= 1) return;

    const t = (e.changedTouches && e.changedTouches[0]) ? e.changedTouches[0] : null;
    if(!t) return;

    const dx = t.clientX - startX;
    const dy = t.clientY - startY;

    if(Math.abs(dx) < SWIPE_MIN) return;
    if(Math.abs(dx) < Math.abs(dy)) return;

    if(dx < 0) next();
    else prev();
  }

  lb.addEventListener('touchstart', onTouchStart, { passive: true });
  lb.addEventListener('touchmove', onTouchMove, { passive: false });
  lb.addEventListener('touchend', onTouchEnd, { passive: true });

  let lastTap = 0;
  lbImg.addEventListener('touchend', () => {
    if(!lb.classList.contains('open')) return;
    const now = Date.now();
    if(now - lastTap < 300) closeLightbox();
    lastTap = now;
  }, { passive: true });
</script>
